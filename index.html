<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Google Place ID Finder</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&family=Noto+Sans+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { 
    font-family: 'Noto Sans', sans-serif; 
    max-width: 650px; 
    margin: 0 auto; 
    padding: 2rem 1.5rem; 
    background-color: rgb(23,23,23);
    color: rgb(210,191,149);
    line-height: 1.6;
  }
  h1 { 
    font-size: 2rem; 
    margin-bottom: 0.5rem; 
    color: rgb(170,101,25);
    font-weight: 700;
    font-family: 'Noto Sans Mono', monospace;
    letter-spacing: -0.5px;
  }
  p { margin-bottom: 1.5rem; }
  label { 
    display: block; 
    margin-top: 1.5rem; 
    font-weight: 400;
    color: rgb(210,191,149);
    font-family: 'Noto Sans Mono', monospace;
    margin-bottom: 0.75rem;
  }
  input { 
    width: 100%; 
    padding: 0.75rem 1rem; 
    font-size: 1rem; 
    font-family: 'Noto Sans Mono', monospace;
    background-color: rgb(35,35,35);
    border: 2px solid rgb(50,50,50);
    border-radius: 8px;
    color: rgb(210,191,149);
    transition: border-color 0.3s ease, background-color 0.3s ease;
  }
  input:focus {
    outline: none;
    border-color: rgb(170,101,25);
    background-color: rgb(40,40,40);
  }
  input::placeholder {
    color: rgb(120,120,120);
  }
  button { 
    width: 100%; 
    padding: 0.875rem 1.5rem; 
    margin-top: 2rem; 
    font-size: 1.05rem; 
    font-weight: 500;
    font-family: 'Noto Sans Mono', monospace;
    background: linear-gradient(135deg, rgb(170,101,25), rgb(140,81,15));
    color: rgb(255,255,255);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.3s ease;
  }
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  }
  button:active {
    transform: translateY(0);
  }
  #output { 
    margin-top: 2rem; 
    word-break: break-all; 
    padding: 1.5rem;
    background-color: rgb(30,30,30);
    border-radius: 12px;
    border: 1px solid rgb(50,50,50);
    border-left: 3px solid rgb(170,101,25);
  }
  #output p {
    margin-bottom: 0.75rem;
  }
  #output p strong {
    color: rgb(170,101,25);
    font-weight: 600;
    font-family: 'Noto Sans Mono', monospace;
  }
  .link-box { 
    margin-top: 1rem; 
    display: flex; 
    gap: 0.75rem; 
  }
  button.copy { 
    flex: 1;
    margin-top: 0;
    padding: 0.625rem 1rem;
    font-size: 0.9rem;
    background: rgb(50,50,50);
    color: rgb(210,191,149);
  }
  button.copy:hover {
    background: rgb(60,60,60);
  }
  a.review-link { 
    flex: 3; 
    text-decoration: none; 
    color: rgb(170,101,25);
    background-color: rgb(40,40,40);
    padding: 0.625rem 1rem;
    border-radius: 8px;
    border: 2px solid rgb(170,101,25);
    text-align: center;
    font-weight: 600;
    transition: background-color 0.3s ease, transform 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  a.review-link:hover {
    background-color: rgb(170,101,25);
    color: rgb(23,23,23);
    transform: translateY(-2px);
  }
  .note { 
    font-size: 0.9rem; 
    color: rgb(150,150,150); 
    margin-top: 0.5rem; 
  }
  .note a {
    color: rgb(170,101,25);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.3s ease;
  }
  .note a:hover {
    border-bottom-color: rgb(170,101,25);
  }
  .debug { 
    font-size: 0.85rem; 
    color: rgb(120,120,120); 
    margin-top: 1rem; 
    font-family: 'Noto Sans Mono', monospace; 
    font-style: italic;
  }
  .storage-note {
    font-size: 0.85rem;
    color: rgb(150,150,150);
    margin-top: 0.5rem;
    padding: 0.75rem;
    background-color: rgb(30,30,30);
    border-left: 3px solid rgb(170,101,25);
    border-radius: 4px;
    font-family: 'Noto Sans Mono', monospace;
  }
</style>
</head>
<body>

<h1>Google Place ID Finder</h1>
<p>Enter your <strong>Google API Key</strong> and a business name or Maps link to retrieve its <strong>Place ID</strong> and review link.</p>

<label>Google API Key:
  <input type="text" id="apiKey" placeholder="Your Google Maps API Key">
</label>
<div class="storage-note">
  Your API key is saved locally in your browser and never sent anywhere except Google's API.
</div>
<div class="note">
  <a href="https://developers.google.com/maps/documentation/places/web-service/get-api-key" target="_blank">
    Get your own Google Maps API Key
  </a>
</div>

<label>Business name or Google Maps URL:
  <input type="text" id="placeInput" placeholder="Enter business name or Google Maps link">
</label>

<button id="fetchBtn">Find Place ID</button>

<div id="output"></div>

<script>
// Track if Google Maps is currently loading
let mapsLoadingPromise = null;
let scriptLoadTimeout = null;

// localStorage utilities (replaces cookies)
function setStoredApiKey(value) {
  try {
    localStorage.setItem('google_api_key', value);
    console.log('API key saved to localStorage');
    return true;
  } catch (e) {
    console.error('Failed to save to localStorage:', e);
    return false;
  }
}

function getStoredApiKey() {
  try {
    const value = localStorage.getItem('google_api_key');
    if (value) {
      console.log('API key retrieved from localStorage:', value.substring(0, 10) + '...');
    } else {
      console.log('No API key found in localStorage');
    }
    return value;
  } catch (e) {
    console.error('Failed to read from localStorage:', e);
    return null;
  }
}

// Cookie utilities
function setCookie(name, value, days) {
  const d = new Date();
  d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
  document.cookie = `${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/;SameSite=Lax`;
}

function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return match ? decodeURIComponent(match[2]) : null;
}

// Extract place ID from Google Maps URL if present
function extractPlaceIdFromUrl(input) {
  // Check for place_id parameter
  const placeIdMatch = input.match(/[?&]place_id=([^&]+)/);
  if (placeIdMatch) return placeIdMatch[1];
  
  // Check for ftid parameter (sometimes used)
  const ftidMatch = input.match(/[?&]ftid=([^&]+)/);
  if (ftidMatch) return ftidMatch[1];
  
  return null;
}

// Extract business name from Google Maps URL
function extractNameFromUrl(input) {
  // Try to extract from /place/ URL structure
  const placeMatch = input.match(/\/place\/([^\/]+)/);
  if (placeMatch) {
    return decodeURIComponent(placeMatch[1].replace(/\+/g, ' '));
  }
  return null;
}

// Store the full API key in memory
let fullApiKey = '';

window.addEventListener('DOMContentLoaded', () => {
  console.log('Page loaded, checking for saved API key...');
  const savedKey = getStoredApiKey();
  if (savedKey) {
    fullApiKey = savedKey;
    const apiKeyInput = document.getElementById('apiKey');
    apiKeyInput.value = maskApiKey(savedKey);
    console.log('API key loaded and masked');
  }
});

// Mask API key after submission
function maskApiKey(apiKey) {
  if (apiKey.length <= 6) return apiKey;
  return '•'.repeat(apiKey.length - 6) + apiKey.slice(-6);
}

// Allow user to click on the API key field to reveal/edit the full key
const apiKeyInput = document.getElementById('apiKey');

apiKeyInput.addEventListener('focus', function() {
  if (fullApiKey && this.value.includes('•')) {
    this.value = fullApiKey;
  }
});

// Mask the API key when user leaves the field (blur event)
apiKeyInput.addEventListener('blur', function() {
  const currentValue = this.value.trim();
  if (currentValue && !currentValue.includes('•')) {
    fullApiKey = currentValue;
    setStoredApiKey(currentValue);
    this.value = maskApiKey(currentValue);
  }
});
function loadGoogleMaps(apiKey) {
  console.log('loadGoogleMaps called');
  
  // If already loaded, return immediately
  if (window.google && window.google.maps && window.google.maps.places) {
    console.log('Google Maps already loaded');
    return Promise.resolve();
  }
  
  // If currently loading, return the existing promise
  if (mapsLoadingPromise) {
    console.log('Google Maps is currently loading, returning existing promise');
    return mapsLoadingPromise;
  }

  // Create new loading promise
  mapsLoadingPromise = new Promise((resolve, reject) => {
    console.log('Creating new Google Maps loading promise');
    
    // Set timeout in case callback never fires
    scriptLoadTimeout = setTimeout(() => {
      console.error('Script load timeout - callback was not called within 10 seconds');
      mapsLoadingPromise = null;
      reject(new Error('Timeout loading Google Maps. Please check your API key and try again.'));
    }, 10000);
    
    // Set up callback before loading script
    window.initMap = () => {
      console.log('initMap callback fired');
      clearTimeout(scriptLoadTimeout);
      delete window.initMap; // Clean up
      
      // Verify the API actually loaded
      if (window.google && window.google.maps && window.google.maps.places) {
        console.log('Google Maps API fully loaded');
        resolve();
      } else {
        console.error('initMap called but API not fully available');
        reject(new Error('Google Maps API did not load properly'));
      }
    };
    
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initMap`;
    script.async = true;
    script.defer = true;
    
    script.onload = () => {
      console.log('Script tag loaded');
    };
    
    script.onerror = (error) => {
      console.error('Script load error:', error);
      clearTimeout(scriptLoadTimeout);
      mapsLoadingPromise = null;
      reject(new Error('Failed to load Google Maps script. Check your API key, internet connection, and browser console for details.'));
    };
    
    console.log('Appending script tag to head');
    document.head.appendChild(script);
  });

  return mapsLoadingPromise;
}

// Search for a place using Text Search (new API)
async function searchPlaceByText(searchQuery) {
  console.log('Searching for place with text:', searchQuery);
  
  const { Place } = await google.maps.importLibrary("places");
  
  const request = {
    textQuery: searchQuery,
    fields: ['id', 'displayName', 'formattedAddress'],
    maxResultCount: 1
  };
  
  const { places } = await Place.searchByText(request);
  
  if (!places || places.length === 0) {
    throw new Error('No results found for the search query');
  }
  
  return places[0];
}

// Get place details by ID (new API)
async function getPlaceById(placeId) {
  console.log('Getting place details for ID:', placeId);
  
  const { Place } = await google.maps.importLibrary("places");
  
  const place = new Place({
    id: placeId,
    requestedLanguage: 'en'
  });
  
  await place.fetchFields({
    fields: ['id', 'displayName', 'formattedAddress']
  });
  
  return place;
}

document.getElementById('fetchBtn').addEventListener('click', async () => {
  const apiKeyInput = document.getElementById('apiKey');
  const apiKey = apiKeyInput.value.trim();
  const input = document.getElementById('placeInput').value.trim();
  const output = document.getElementById('output');
  output.textContent = '';

  if (!apiKey || !input) {
    output.textContent = 'Enter both API key and location input.';
    return;
  }

  // If the field shows masked key, use the stored full key
  // Otherwise, save and use the new key
  if (!apiKey.includes('•')) {
    fullApiKey = apiKey;
    setStoredApiKey(apiKey);
    apiKeyInput.value = maskApiKey(apiKey);
  }
  
  output.innerHTML = 'Loading...<div class="debug">Check browser console (F12) for debug info</div>';
  
  console.log('=== Starting place search ===');
  console.log('API Key:', fullApiKey.substring(0, 10) + '...');
  console.log('Input:', input);

  try {
    console.log('Calling loadGoogleMaps...');
    await loadGoogleMaps(fullApiKey);
    console.log('Google Maps loaded successfully');

    let place;
    
    // Check if input is a Google Maps URL with a place_id
    const extractedPlaceId = extractPlaceIdFromUrl(input);
    console.log('Extracted Place ID:', extractedPlaceId);
    
    if (extractedPlaceId) {
      // Get place by ID using new API
      place = await getPlaceById(extractedPlaceId);
    } else {
      // Extract business name from URL or use input as-is
      const searchQuery = extractNameFromUrl(input) || input;
      console.log('Search query:', searchQuery);
      
      // Search for place using new API
      place = await searchPlaceByText(searchQuery);
    }
    
    console.log('Place found:', place);
    displayPlaceInfo(place, output);

  } catch (err) {
    console.error('Error:', err);
    output.innerHTML = `<p style="color:red;"><strong>Error:</strong> ${err.message}</p><div class="debug">Check browser console (F12) for full error details</div>`;
  }
});

function displayPlaceInfo(place, output) {
  console.log('Displaying place info:', place);
  
  // The new API uses 'id' instead of 'place_id'
  const placeId = place.id;
  const placeName = place.displayName || 'N/A';
  const placeAddress = place.formattedAddress || 'N/A';
  const reviewUrl = `https://search.google.com/local/writereview?placeid=${placeId}`;

  output.innerHTML = `
    <p><strong>Place:</strong> ${placeName}</p>
    <p><strong>Address:</strong> ${placeAddress}</p>
    <p><strong>Place ID:</strong> ${placeId}</p>
    <div class="link-box">
      <a href="${reviewUrl}" class="review-link" target="_blank">Google Review Page</a>
      <button class="copy">Copy Link</button>
    </div>
  `;

  output.querySelector('button.copy').addEventListener('click', () => {
    navigator.clipboard.writeText(reviewUrl).then(() => {
      alert('Review link copied!');
    }).catch(() => {
      alert('Failed to copy. Please copy manually.');
    });
  });
}
</script>

</body>
</html>
